<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB Management Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-700">Database Management Console</h1>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-app-versions" onclick="switchTab('app-versions')" class="tab-button active font-medium px-3 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">App Versions</button>
                <button id="tab-user-devices" onclick="switchTab('user-devices')" class="tab-button font-medium px-3 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">User Devices</button>
            </nav>
        </div>

        <!-- App Versions Table Section -->
        <div id="content-app-versions" class="tab-content bg-white p-6 rounded-lg shadow-md">
            <!-- Latest Version Card -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg shadow-sm mb-6 border border-blue-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Get Latest Version</h3>
                <div class="flex flex-col sm:flex-row items-center gap-3">
                    <select id="latestVersionPlatform" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                        <option value="ANDROID">Android</option>
                        <option value="IOS">iOS</option>
                    </select>
                    <button onclick="fetchLatestVersion()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg shadow transition duration-150">
                        Get Latest Version
                    </button>
                    <div id="latestVersionResult" class="flex-1 text-sm text-gray-700 font-medium hidden">
                        <!-- Result will be displayed here -->
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <h2 class="text-2xl font-semibold">App Versions</h2>
                <div class="flex items-center gap-2">
                    <input type="text" id="appVersionSearch" placeholder="Filter by version..." class="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button onclick="openModal('appVersionModal')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow w-full sm:w-auto">Add New Version</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left">ID</th>
                            <th class="py-3 px-4 text-left">Version</th>
                            <th class="py-3 px-4 text-left">Platform</th>
                            <th class="py-3 px-4 text-left">Release Date</th>
                            <th class="py-3 px-4 text-left">Changelog</th>
                            <th class="py-3 px-4 text-left">Update Type</th>
                            <th class="py-3 px-4 text-left">Active</th>
                            <th class="py-3 px-4 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="appVersionTableBody">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- User Devices Table Section -->
        <div id="content-user-devices" class="tab-content bg-white p-6 rounded-lg shadow-md hidden">
             <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <h2 class="text-2xl font-semibold">User Devices</h2>
                 <div class="flex flex-col sm:flex-row items-center gap-2 w-full sm:w-auto">
                    <input type="number" id="userDeviceUserIdSearch" placeholder="Filter by User ID..." class="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="userDeviceVersionSearch" placeholder="Filter by Version..." class="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button onclick="openModal('userDeviceModal')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow w-full sm:w-auto">Add New Device</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left">ID</th>
                            <th class="py-3 px-4 text-left">User ID</th>
                            <th class="py-3 px-4 text-left">Platform</th>
                            <th class="py-3 px-4 text-left">Current Version</th>
                            <th class="py-3 px-4 text-left">Last Seen</th>
                            <th class="py-3 px-4 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userDeviceTableBody">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- App Version Modal -->
    <div id="appVersionModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="appVersionModalTitle" class="text-xl font-semibold mb-4">Add App Version</h3>
            <form id="appVersionForm">
                <input type="hidden" id="appVersionId">
                <div class="mb-4">
                    <label for="version" class="block text-sm font-medium text-gray-700">Version</label>
                    <input type="text" id="version" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="platform" class="block text-sm font-medium text-gray-700">Platform</label>
                    <select id="platform" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option>ANDROID</option>
                        <option>IOS</option>
                    </select>
                </div>
                 <div class="mb-4">
                    <label for="changelog" class="block text-sm font-medium text-gray-700">Changelog</label>
                    <textarea id="changelog" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="mb-4">
                    <label for="updateType" class="block text-sm font-medium text-gray-700">Update Type</label>
                     <select id="updateType" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option>MANDATORY</option>
                        <option>OPTIONAL</option>
                        <option>DEPRECATED</option>
                    </select>
                </div>
                <div class="mb-4 flex items-center">
                    <input type="checkbox" id="active" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="active" class="ml-2 block text-sm text-gray-900">Is Active</label>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeModal('appVersionModal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Cancel</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Device Modal -->
    <div id="userDeviceModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="userDeviceModalTitle" class="text-xl font-semibold mb-4">Add User Device</h3>
            <form id="userDeviceForm">
                 <input type="hidden" id="userDeviceId">
                <div class="mb-4">
                    <label for="userId" class="block text-sm font-medium text-gray-700">User ID</label>
                    <input type="number" id="userId" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="userDevicePlatform" class="block text-sm font-medium text-gray-700">Platform</label>
                    <select id="userDevicePlatform" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option>ANDROID</option>
                        <option>IOS</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="currentVersion" class="block text-sm font-medium text-gray-700">Current Version</label>
                    <input type="text" id="currentVersion" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="lastSeen" class="block text-sm font-medium text-gray-700">Last Seen</label>
                    <input type="datetime-local" id="lastSeen" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeModal('userDeviceModal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Cancel</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom alert/message box -->
    <div id="messageBox" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden z-index-100">
        <p id="messageText"></p>
    </div>


<script>
    const API_BASE_URL = 'http://localhost:8080/api';

    // --- Utility Functions ---
    function showMessage(message, isError = false) {
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        messageText.textContent = message;
        messageBox.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
        messageBox.classList.remove('hidden');
        setTimeout(() => {
            messageBox.classList.add('hidden');
        }, 3000);
    }
    
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleString();
    }
    
    // --- Tab Switching ---
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
        document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
        document.getElementById(`content-${tabName}`).classList.remove('hidden');
        document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // --- Modal Handling ---
    function openModal(modalId, data = null) {
        const modal = document.getElementById(modalId);
        modal.classList.remove('hidden');

        if (modalId === 'appVersionModal') {
            const form = document.getElementById('appVersionForm');
            const title = document.getElementById('appVersionModalTitle');
            if (data) {
                title.textContent = 'Edit App Version';
                document.getElementById('appVersionId').value = data.id;
                document.getElementById('version').value = data.version;
                document.getElementById('platform').value = data.platform;
                document.getElementById('changelog').value = data.changelog;
                document.getElementById('updateType').value = data.updateType;
                document.getElementById('active').checked = data.active;
            } else {
                title.textContent = 'Add App Version';
                form.reset();
                document.getElementById('appVersionId').value = '';
            }
        } else if (modalId === 'userDeviceModal') {
            const form = document.getElementById('userDeviceForm');
            const title = document.getElementById('userDeviceModalTitle');
            if(data) {
                title.textContent = 'Edit User Device';
                document.getElementById('userDeviceId').value = data.id;
                document.getElementById('userId').value = data.userId;
                document.getElementById('userDevicePlatform').value = data.platform;
                document.getElementById('currentVersion').value = data.currentVersion;
                document.getElementById('lastSeen').value = data.lastSeen ? data.lastSeen.slice(0, 16) : '';
            } else {
                title.textContent = 'Add User Device';
                form.reset();
                 document.getElementById('userDeviceId').value = '';
            }
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    }

    // --- App Version API Calls ---
    async function fetchAppVersions() {
        // CORRECTED: Always use the filter endpoint for consistency.
        const searchTerm = document.getElementById('appVersionSearch').value;
        const params = new URLSearchParams();
        if (searchTerm) {
            params.append('version', searchTerm);
        }
        const url = `${API_BASE_URL}/appVersionFilter?${params.toString()}`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch app versions');
            
            // CORRECTED: Always expect a Page object from the filter endpoint.
            const page = await response.json();
            const data = page.content;

            const tableBody = document.getElementById('appVersionTableBody');
            tableBody.innerHTML = '';
            if (data) {
                data.forEach(v => {
                    const row = `
                        <tr class="border-b">
                            <td class="py-2 px-4">${v.id}</td>
                            <td class="py-2 px-4">${v.version}</td>
                            <td class="py-2 px-4">${v.platform || 'N/A'}</td>
                            <td class="py-2 px-4">${formatDate(v.releaseDate)}</td>
                            <td class="py-2 px-4">${v.changelog || 'N/A'}</td>
                            <td class="py-2 px-4">${v.updateType || 'N/A'}</td>
                            <td class="py-2 px-4">${v.active ? 'Yes' : 'No'}</td>
                            <td class="py-2 px-4 text-center">
                                <button onclick='openModal("appVersionModal", ${JSON.stringify(v)})' class="text-blue-500 hover:underline mr-2">Edit</button>
                                <button onclick="deleteAppVersion(${v.id})" class="text-red-500 hover:underline">Delete</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }
        } catch (error) {
            console.error('Error fetching app versions:', error);
            showMessage('Error fetching app versions', true);
        }
    }
    
    async function saveAppVersion(event) {
        event.preventDefault();
        const id = document.getElementById('appVersionId').value;
        const appVersion = {
            version: document.getElementById('version').value,
            platform: document.getElementById('platform').value,
            changelog: document.getElementById('changelog').value,
            updateType: document.getElementById('updateType').value,
            active: document.getElementById('active').checked
        };

        const url = id ? `${API_BASE_URL}/appVersions/${id}` : `${API_BASE_URL}/appVersions`;
        const method = id ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(appVersion)
            });
            if (!response.ok) throw new Error(`Failed to save app version. Status: ${response.status}`);
            
            showMessage(`App version successfully ${id ? 'updated' : 'created'}!`);
            closeModal('appVersionModal');
            fetchAppVersions();
        } catch(error) {
            console.error('Error saving app version:', error);
            showMessage('Error saving app version', true);
        }
    }
    
    async function deleteAppVersion(id) {
        if (!confirm('Are you sure you want to delete this app version?')) return;
        try {
            const response = await fetch(`${API_BASE_URL}/appVersions/${id}`, { method: 'DELETE' });
            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`Failed to delete app version. Server says: ${errorData}`);
            }
            showMessage('App version deleted successfully!');
            fetchAppVersions();
        } catch (error) {
            console.error('Error deleting app version:', error);
            showMessage('Error deleting app version', true);
        }
    }

    async function fetchLatestVersion() {
        const platform = document.getElementById('latestVersionPlatform').value;
        const resultDiv = document.getElementById('latestVersionResult');
        
        try {
            const response = await fetch(`${API_BASE_URL}/appVersions/latest?platform=${platform}`);
            
            if (!response.ok) {
                if (response.status === 404) {
                    resultDiv.innerHTML = `<span class="text-red-600">❌ No active version found for ${platform}</span>`;
                } else {
                    throw new Error('Failed to fetch latest version');
                }
            } else {
                const latestVersion = await response.json();
                resultDiv.innerHTML = `
                    <div class="bg-white p-3 rounded border border-green-300 shadow-sm">
                        <span class="text-green-600 font-semibold">✓ Latest ${platform} Version:</span>
                        <span class="text-gray-900 font-bold ml-2">${latestVersion.version}</span>
                        <span class="text-gray-600 ml-2">|</span>
                        <span class="text-gray-600 ml-2">${latestVersion.updateType}</span>
                        <span class="text-gray-600 ml-2">|</span>
                        <span class="text-gray-600 ml-2">Released: ${formatDate(latestVersion.releaseDate)}</span>
                    </div>
                `;
                showMessage(`Latest ${platform} version found!`);
            }
            
            resultDiv.classList.remove('hidden');
        } catch (error) {
            console.error('Error fetching latest version:', error);
            resultDiv.innerHTML = `<span class="text-red-600">❌ Error fetching latest version</span>`;
            resultDiv.classList.remove('hidden');
            showMessage('Error fetching latest version', true);
        }
    }

    // --- User Device API Calls ---
    async function fetchUserDevices() {
        // CORRECTED: Always use the filter endpoint for consistency.
        const userId = document.getElementById('userDeviceUserIdSearch').value;
        const version = document.getElementById('userDeviceVersionSearch').value;
        
        const params = new URLSearchParams();
        if (userId) params.append('userId', userId);
        if (version) params.append('version', version);

        const url = `${API_BASE_URL}/userDeviceFilter?${params.toString()}`;

        try {
            const response = await fetch(url);
             if (!response.ok) throw new Error('Failed to fetch user devices');
            
            // CORRECTED: Always expect a Page object from the filter endpoint.
            const page = await response.json();
            const data = page.content;

            const tableBody = document.getElementById('userDeviceTableBody');
            tableBody.innerHTML = '';
            if (data) {
                data.forEach(d => {
                    const row = `
                        <tr class="border-b">
                            <td class="py-2 px-4">${d.id}</td>
                            <td class="py-2 px-4">${d.userId}</td>
                            <td class="py-2 px-4">${d.platform || 'N/A'}</td>
                            <td class="py-2 px-4">${d.currentVersion}</td>
                            <td class="py-2 px-4">${formatDate(d.lastSeen)}</td>
                            <td class="py-2 px-4 text-center">
                               <button onclick='openModal("userDeviceModal", ${JSON.stringify(d)})' class="text-blue-500 hover:underline mr-2">Edit</button>
                               <button onclick="deleteUserDevice(${d.id})" class="text-red-500 hover:underline">Delete</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }
        } catch (error) {
            console.error('Error fetching user devices:', error);
            showMessage('Error fetching user devices', true);
        }
    }

    async function saveUserDevice(event) {
        event.preventDefault();
        const id = document.getElementById('userDeviceId').value;
        const userDevice = {
            userId: document.getElementById('userId').value,
            platform: document.getElementById('userDevicePlatform').value,
            currentVersion: document.getElementById('currentVersion').value,
            lastSeen: document.getElementById('lastSeen').value ? new Date(document.getElementById('lastSeen').value).toISOString() : null,
        };

        const url = id ? `${API_BASE_URL}/userDevices/${id}` : `${API_BASE_URL}/userDevices`;
        const method = id ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userDevice)
            });
            if (!response.ok) throw new Error(`Failed to save user device. Status: ${response.status}`);
            
            showMessage(`User device successfully ${id ? 'updated' : 'created'}!`);
            closeModal('userDeviceModal');
            fetchUserDevices();
        } catch(error) {
            console.error('Error saving user device:', error);
            showMessage('Error saving user device', true);
        }
    }

    async function deleteUserDevice(id) {
        if (!confirm('Are you sure you want to delete this user device?')) return;
        try {
            const response = await fetch(`${API_BASE_URL}/userDevices/${id}`, { method: 'DELETE' });
             if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`Failed to delete user device. Server says: ${errorData}`);
            }
            showMessage('User device deleted successfully!');
            fetchUserDevices();
        } catch (error) {
            console.error('Error deleting user device:', error);
            showMessage('Error deleting user device', true);
        }
    }

    // --- Debounce function for search inputs ---
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchAppVersions();
        fetchUserDevices();
        
        document.getElementById('appVersionForm').addEventListener('submit', saveAppVersion);
        document.getElementById('userDeviceForm').addEventListener('submit', saveUserDevice);

        // --- Search Event Listeners ---
        const debouncedAppVersionSearch = debounce(fetchAppVersions, 300);
        document.getElementById('appVersionSearch').addEventListener('input', debouncedAppVersionSearch);

        const debouncedUserDeviceSearch = debounce(fetchUserDevices, 300);
        document.getElementById('userDeviceUserIdSearch').addEventListener('input', debouncedUserDeviceSearch);
        document.getElementById('userDeviceVersionSearch').addEventListener('input', debouncedUserDeviceSearch);
    });

</script>

</body>
</html>
